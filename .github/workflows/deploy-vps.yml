# Auto-Deploy to VPS on push to main
# Triggers after MergeGuard approves and merges a PR
# Also triggers on direct pushes to main

name: Deploy to VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    name: "Deploy to VPS"
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            REPO_NAME="${{ github.event.repository.name }}"
            PROJECT_DIR="/home/ubuntu/projects/$REPO_NAME"

            echo "=== Deploying $REPO_NAME to VPS ==="

            if [ -d "$PROJECT_DIR" ]; then
              cd "$PROJECT_DIR"
              git fetch origin
              git reset --hard origin/main
              echo "Updated $REPO_NAME to $(git rev-parse --short HEAD)"

              # Auto-detect and restart services
              if [ -f "docker-compose.yml" ] || [ -f "docker-compose.yaml" ]; then
                echo "Docker Compose detected, restarting..."
                docker compose up -d --build 2>/dev/null || docker-compose up -d --build 2>/dev/null
              elif [ -f "requirements.txt" ] && [ -f "app.py" -o -f "main.py" ]; then
                echo "Python app detected"
                # Restart via systemd if service exists
                SERVICE_NAME=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
                if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
                  sudo systemctl restart "$SERVICE_NAME"
                  echo "Restarted systemd service: $SERVICE_NAME"
                fi
              elif [ -f "package.json" ]; then
                echo "Node app detected"
                npm install --production 2>/dev/null
                SERVICE_NAME=$(echo "$REPO_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
                if systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
                  sudo systemctl restart "$SERVICE_NAME"
                  echo "Restarted systemd service: $SERVICE_NAME"
                fi
              fi

              echo "Deploy complete for $REPO_NAME"
            else
              echo "Project directory not found, cloning..."
              git clone git@github.com:alexroll/$REPO_NAME.git "$PROJECT_DIR"
              echo "Cloned $REPO_NAME"
            fi
